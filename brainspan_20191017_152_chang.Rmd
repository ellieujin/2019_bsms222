---
title: "R Notebook"
output: html_notebook
---
```{bash}
wget https://www.dropbox.com/s/u3ii9x4wpnzazm5/data_brainspan_DFC.20190928.Rdata
```

```{r}
load('data_brainspan_DFC.20190928.Rdata')
```

```{r}
library(dslabs)
library(tidyverse)
library(ggthemes)
```


```{r}
## stage group 만들기
s<-s %>%
  mutate(stage=case_when(
    age %in% c("8 pcw","9 pcw", "12 pcw") ~ 2,
    age %in% c("13 pcw","16 pcw", "17 pcw") ~ 3,
    age %in% c("19 pcw","21 pcw", "24 pcw") ~ 4,
    age %in% c("26 pcw","37 pcw") ~ 5,
    age %in% c("4 mos") ~ 6,
    age %in% c("10 mos","1 yrs") ~ 7,
    age %in% c("2 yrs","3 yrs", "4 yrs") ~ 8,
    age %in% c("8 yrs","11 yrs") ~ 9,
    age %in% c("13 yrs","18 yrs", "19 yrs") ~ 10,
    TRUE ~ 11))
```

```{r}
## gene type에 따른 발현량 넣을 공간 마련하기
s<-s %>%
  mutate(protein_coding=0 , activated_ig=0, inactivated_ig=0, noncoding_rna=0) 
```

```{r}
## ind에 g data의 해당 gene type만 추출한 index 넣기

ind_pc<-(g$gene_type == "protein_coding" & !is.na(g$gene_type))

ind_a_ig<-(g$gene_type %in% c("IG_C_gene","IG_D_gene","IG_J_gene","IG_LV_gene","IG_V_gene","TR_C_gene","TR_J_gene","TR_V_gene","TR_D_gene") & !is.na(g$gene_type))

ind_ia_ig<-(g$gene_type %in% c("IG_pseudogene","IG_C_pseudogene","IG_J_pseudogene","IG_V_pseudogene", "TR_V_pseudogene","TR_J_pseudogene") & !is.na(g$gene_type))

ind_nc_rna<-(g$gene_type %in% c("Mt_rRNA","Mt_tRNA","miRNA","misc_RNA","rRNA","scRNA","snRNA","snoRNA","ribozyme","sRNA","scaRNA") & !is.na(g$gene_type))
```

```{r}
## length 사용해서 해당 gene type의 총 개수를 구하기 위함
pc<-g$row_num[ind_pc]
a_ig<-g$row_num[ind_a_ig]
ia_ig<-g$row_num[ind_ia_ig]
nc_rna<-g$row_num[ind_nc_rna]
```

```{r}
## 35명의 해당 gene type의 평균 발현량 구하기
compute_avg_pc <- function(n){
  a<-as.character(n)
  b<-paste0("X",a)
  s$protein_coding[n]<-sum(e[[b]][ind_pc]) / length(pc)
}

compute_avg_a_ig <- function(n){
  a<-as.character(n)
  b<-paste0("X",a)
  s$activated_ig[n]<-sum(e[[b]][ind_a_ig]) / length(a_ig)
}

compute_avg_ia_ig <- function(n){
  a<-as.character(n)
  b<-paste0("X",a)
  s$inactivated_ig[n]<-sum(e[[b]][ind_ia_ig]) / length(ia_ig)
}

compute_avg_nc_rna <- function(n){
  a<-as.character(n)
  b<-paste0("X",a)
  s$noncoding_rna[n]<-sum(e[[b]][ind_nc_rna]) / length(nc_rna)
}


y<-1:35
s$protein_coding<-sapply(y,compute_avg_pc)
s$activated_ig<-sapply(y,compute_avg_a_ig)
s$inactivated_ig<-sapply(y,compute_avg_ia_ig)
s$noncoding_rna<-sapply(y,compute_avg_nc_rna)
```

```{r}
## stage별 평균 구해서 color blind friendly 색으로 line 그리기
#p<-
s %>%
  group_by(stage) %>%
  summarise(avg_pc = mean(protein_coding), avg_a_ig = mean(activated_ig), avg_ia_ig=mean(inactivated_ig), avg_nc_rna=mean(noncoding_rna)) %>%
  ggplot() +
  geom_line(aes(stage, avg_pc),col="#CC79A7") +
  geom_line(aes(stage, avg_a_ig),col="#009E73") +
  geom_line(aes(stage, avg_ia_ig),col="#56B4E9") +
  geom_line(aes(stage, avg_nc_rna),col="#E69F00") +
  geom_text(aes(x=10,y=5,label="Protein coding"),colour="#CC79A7")+
  geom_text(aes(x=10, y=0.4,label="Non-coding RNA"), colour="#E69F00")+
  geom_text(aes(x=10, y=0.07,label="Activated Ig"), colour="#009E73")+
  geom_text(aes(x=10, y=0.003,label="Inactivated Ig"), colour="#56B4E9")+
  scale_y_log10() +
  scale_x_continuous(breaks = seq(0,12,1)) +
  ggtitle("Gene Expression in Brain by Stage") + 
  xlab("Stage") + 
  ylab("Expression (RPKM, log scale)")+
  theme(panel.grid.minor.x = element_blank())
```

```{r}
#ggsave("plot.BrainSpan.line_GeneExpressionByStage.20191017.pdf",p, width=9, height=9)
```
